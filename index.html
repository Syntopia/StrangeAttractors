<!DOCTYPE html>
<html>

<head>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
	<style type="text/css">
		html,
		body {
			font-family: Helvetica, Arial, sans-serif;
			padding: 0px;
			color: white;
			font-size: 18px;
			margin: 0px;
			overflow: hidden;
			background: black;
		}

		/* Bret Victor style 'Tangle' inspired links (http://worrydream.com/Tangle/) */

		a {
			color: #ddf;
			border-bottom: 1px solid rgba(178, 178, 255, .5);
			text-decoration: none;
		}

		a:hover {
			color: #ddf;
			border-bottom: none;
			text-decoration: none;
		}



		a.toggle:hover {
			border-color: #ddf;
			text-decoration: none;
		}

		a.toggle {
			border-bottom: 1.5px dotted #ddf;
			padding: 0px 1px;
			cursor: pointer;
			text-decoration: none;
		}

		/* The modal text box is based on code from: http://www.w3schools.com/howto/howto_css_modals.asp */

		/* The Modal (background) */

		.modal {
			display: none;
			/* Hidden by default */
			position: fixed;
			/* Stay in place */
			z-index: 1;
			/* Sit on top */
			padding-top: 100px;
			/* Location of the box */
			left: 0;
			top: 0;
			width: 100%;
			/* Full width */
			height: 100%;
			/* Full height */
			overflow: auto;
			/* Enable scroll if needed */
			/* Fallback color */
			background-color: rgba(0, 0, 0, 0.4);
			/* Black w/ opacity */
		}

		/* Modal Content */

		.modal-content {
			background-color: rgba(30, 30, 50, 0.8);
			color: #fff;
			margin: auto;
			padding: 20px;
			border: 1px solid #888;
			width: 80%;
		}

		/* ------------------------------------------------------------------------------------------------------------------- */

		/* all of this style code just styles the input slider (autogenerated from http://www.cssportal.com/style-input-range/) */

		input[type=range] {
			-webkit-appearance: none;
			margin: 0px 0;
			width: 100%;
		}

		input[type=range]:focus {
			outline: none;
		}

		input[type=range]::-webkit-slider-runnable-track {
			width: 100%;
			height: 1px;
			cursor: pointer;
			animate: 0.2s;
			box-shadow: 0px 0px 0px #858585;
			background: #3071A9;
			border-radius: 0px;
			border: 1px solid #878787;
		}

		input[type=range]::-webkit-slider-thumb {
			box-shadow: 1px 1px 1px #000000;
			border: 1px solid #000000;
			height: 16px;
			width: 16px;
			border-radius: 16px;
			background: #FFFFFF;
			cursor: pointer;
			-webkit-appearance: none;
			margin-top: -8.5px;
		}

		input[type=range]:focus::-webkit-slider-runnable-track {
			background: #3071A9;
		}

		input[type=range]::-moz-range-track {
			width: 100%;
			height: 1px;
			cursor: pointer;
			animate: 0.2s;
			box-shadow: 0px 0px 0px #858585;
			background: #3071A9;
			border-radius: 0px;
			border: 1px solid #878787;
		}

		input[type=range]::-moz-range-thumb {
			box-shadow: 1px 1px 1px #000000;
			border: 1px solid #000000;
			height: 16px;
			width: 16px;
			border-radius: 16px;
			background: #FFFFFF;
			cursor: pointer;
		}

		input[type=range]::-ms-track {
			width: 100%;
			height: 1px;
			cursor: pointer;
			animate: 0.2s;
			background: transparent;
			border-color: transparent;
			color: transparent;
		}

		input[type=range]::-ms-fill-lower {
			background: #3071A9;
			border: 1px solid #878787;
			border-radius: 0px;
			box-shadow: 0px 0px 0px #858585;
		}

		input[type=range]::-ms-fill-upper {
			background: #3071A9;
			border: 1px solid #878787;
			border-radius: 0px;
			box-shadow: 0px 0px 0px #858585;
		}

		input[type=range]::-ms-thumb {
			box-shadow: 1px 1px 1px #000000;
			border: 1px solid #000000;
			height: 16px;
			width: 16px;
			border-radius: 16px;
			background: #FFFFFF;
			cursor: pointer;
		}

		input[type=range]:focus::-ms-fill-lower {
			background: #3071A9;
		}

		input[type=range]:focus::-ms-fill-upper {
			background: #3071A9;
		}
	</style>
</head>

<body>
	<div style="position: fixed; top: 30px; padding: 10px;">&nbsp;

		<img src="logo.png" />
	</div>
	<div style="position: fixed; left: 10px; top: 80px; padding: 10px 30px 30px 30px;" id="ui">
		<p>
			by Mikael Hvidtfeldt Christensen (
			<a href="https://twitter.com/syntopiadk" target="_blank">@SyntopiaDK</a>).
			<p>
				<br/>

				<a href="javascript:showAbout();">More...</a>

				</p/>
				<p>
				</p>
	</div>
	<div id="container"></div>
	<script src="https://cdn.jsdelivr.net/g/filesaver.js"></script>
	
	<script src="js/three.min.js" type="text/javascript"></script>
	<script src="js/OrbitControls.js" type="text/javascript"></script>
	<script src="js/RGBELoader.js" type="text/javascript"></script>
	<script src="js/HDRCubeTextureLoader.js" type="text/javascript"></script>

	<script src="js/Detector.js" type="text/javascript"></script>
	<script src="js/stats.min.js" type="text/javascript"></script>

	<script src="js/Half.js" type="text/javascript"></script>
	<script src="js/Encodings.js" type="text/javascript"></script>
	<script src="js/PMREMGenerator.js" type="text/javascript"></script>
	<script src="js/PMREMCubeUVPacker.js" type="text/javascript"></script>
	<script src="js/dat.gui.min.js" type="text/javascript"></script>

	<script src="js/shaders/FilmShader.js" type="text/javascript"></script>
	<script src="js/shaders/VignetteShader.js" type="text/javascript"></script>
	<script src="js/postprocessing/EffectComposer.js" type="text/javascript"></script>
	<script src="js/postprocessing/RenderPass.js" type="text/javascript"></script>
	<script src="js/postprocessing/FilmPass.js" type="text/javascript"></script>
	<script src="js/postprocessing/MaskPass.js" type="text/javascript"></script>
	<script src="js/postprocessing/ShaderPass.js" type="text/javascript"></script>
	<script src="js/postprocessing/SSAOPass.js"></script>
	<script src="js/shaders/DepthLimitedBlurShader.js"></script>
	<script src="js/shaders/UnpackDepthRGBAShader.js"></script>

	<script src="js/shaders/CopyShader.js" type="text/javascript"></script>
	<script src="js/shaders/SSAOShader.js" type="text/javascript"></script>

	<script src="js/shaders/ConvolutionShader.js" type="text/javascript"></script>
	<script src="js/shaders/LuminosityHighPassShader.js" type="text/javascript"></script>
	<script src="js/postprocessing/UnrealBloomPass.js" type="text/javascript"></script>
	<script src="AttractorCurve.js" type="text/javascript"></script>
	<script src="Attractors.js" type="text/javascript"></script>
	<script src="js/OBJExporter.js" type="text/javascript"></script>
	<script src="js/STLExporter.js" type="text/javascript"></script>
	<div id="functionExamples" class="modal">
		<div id="functionExamplesDiv" class="modal-content">

		</div>
	</div>

	<div id="aboutBox" class="modal">
		<div id="aboutBoxDiv" class="modal-content">
			<br/>
			<img src="logo.png" />
			<br />by Mikael Hvidtfeldt Christensen (
			<a href="https://twitter.com/syntopiadk" target="_blank">@SyntopiaDK</a>,
			<a href="http://www.hvidtfeldts.net" target="_blank">homepage</a>)

			<p>
				<a class=toggle href='javascript:saveAsImage();'>Save attractor as image (PNG)</a> (or press 'return')
				<div id="exportSlider"></div>
				<br />
				<a class=toggle href='javascript:exportAsObj();'>Save attractor as 3D (OBJ)</a>
				<br />
				<a class=toggle href='javascript:exportAsStl();'>Save attractor as 3D (STL)</a>
			</p>
			<p>
				<br />
			</p>
			<p>
				<b>Attribution</b>
				<br /> Source code for this project
				<a href="https://github.com/Syntopia/StrangeAttractors" target="_blank">on Github</a>.
				<br /> Inspired by the wonderful
				<a href="https://www.behance.net/gallery/7618879/Strange-Attractors" target="_blank">renderings by Chaotic Atmosphere</a>
				<br /> Formulas from JÃ¼rgen Meier:
				<a href="http://www.3d-meier.de/tut19/Seite300.html" target="_blank">code</a> /
				<a href="http://www.3d-meier.de/tut19/Seite0.html" target="_blank">descriptions</a>
				<br> 3D graphics using
				<a href="https://threejs.org/" target="_blank">three.js</a>.
				<br> GUI using
				<a href="https://github.com/dataarts/dat.gui" target="_blank">dat.gui</a>.
			</p>
			<br/>
			<p>Version 1.0 - Jan 13, 2018.</p>
		</div>
	</div>

	<div id="savingBox" class="modal">
		<div id="savingBoxDiv" class="modal-content">
			<p>Preparing image.</p><p>Image will automatically download when ready...</p>
		</div>
	</div>


	<script type="text/javascript">
		var Settings = {};

		var ui = document.getElementById('ui');

		var functionDialog = document.getElementById('functionExamples');
		var functionExamplesDiv = document.getElementById('functionExamplesDiv');
		var aboutDialog = document.getElementById('aboutBox');
		var aboutDialogDiv = document.getElementById('aboutBoxDiv');

		var attractors = getAttractors();
		var attractor = attractors[0];


		attractorDefaults = [];
		for (var i = 0; i < attractors.length; i++) {
			var defaults = {};
			for (var key in attractors[i]) {
				if (attractors[i].hasOwnProperty(key)) {
					defaults[key] = attractors[i][key];
				}
			}
			attractorDefaults.push(defaults);
		}

		var wireframeMaterial = new THREE.MeshBasicMaterial();
		wireframeMaterial.wireframe = true;

		functionExamplesDiv.insertAdjacentHTML('beforeend', "<h3>Select attractor</h3>");
		for (var i = 0; i < attractors.length; i++) {
			functionExamplesDiv.insertAdjacentHTML('beforeend', "<p><a href='javascript:setAttractor(" + i + ");'>" + attractors[i].getName() + "</a></p>");
		}

		function updateAttractor() {
			if (mesh !== undefined) {
				scene.remove(mesh);
				mesh.geometry.dispose();
			}
			var path = new AttractorCurve(params.steps * 1000, attractor, params.radius, params.stepSize, params.facets);
			path.init();
			mesh = new THREE.Mesh(path.getGeometry(), params.wireframe ? wireframeMaterial : standardMaterial);
			mesh.receiveShadow = true;
			mesh.castShadow = true;
			scene.add(mesh);


		}

		function setAttractor(index) {
			attractor = attractors[index];

			// Set to default
			for (var key in attractor) {
				if (attractor.hasOwnProperty(key)) {
					attractor[key] = attractorDefaults[index][key];
				}
			}

			updateAttractor();

			if (controls != undefined) {
				var center = new THREE.Box3().setFromObject(mesh).getCenter();
				controls.target.set(center.x, center.y, center.z);
			}

			var elem = document.querySelector('.dynamicUI');
			while (elem !== null) {
				elem.parentNode.removeChild(elem);
				elem = document.querySelector('.dynamicUI');
			}

			ui.insertAdjacentHTML('beforeend', "<div class='dynamicUI'>Attractor: <a class=toggle href='javascript:showFunctionExamples();' >" + attractor.getName() + "</a> </div>");

			for (var key in attractor) {
				if (attractor.hasOwnProperty(key)) {
					createSlider(ui, key, key, attractor[key], 0, attractor[key] * 5);
				}
			}

			functionDialog.style.display = "none";
		}

		function showFunctionExamples() {
			functionDialog.style.display = "block";
		}

		function showAbout() {
			aboutDialog.style.display = "block";
		}

		function showSavingBox() {
			aboutDialog.style.display = "none";
			savingBox.style.display = "block";
			setTimeout(function(){ hideSavingBox(); }, 5000);
		}

		function hideSavingBox() {
			savingBox.style.display = "none";
		}

		window.onclick = function (event) {
			if (event.target == functionDialog) {
				functionDialog.style.display = "none";
			}
			if (event.target == aboutDialog) {
				aboutDialog.style.display = "none";
			}
			if (event.target == savingBox) {
				savingBox.style.display = "none";
			}
		}

		function createSlider(container, name, label, defaultValue, min, max) {
			var html = "<div class='dynamicUI'><span id='" + name + "Label'>" + label + "&nbsp;&nbsp;</span>";
			html += "<input id='" + name + "Slider' value='" + 100 * (defaultValue - min) / (max - min) + "' type='range' min='0' max='100' style='width: 300px;'>";
			html += "&nbsp;&nbsp;<span id='" + name + "Value'>" + defaultValue.toFixed(3) + "</span></div>";
			container.insertAdjacentHTML('beforeend', html);

			var slider = document.getElementById(name + "Slider");
			var value = document.getElementById(name + "Value");
			slider.addEventListener('input', function () {
				var val = slider.value * 0.01 * (max - min) + min;
				value.innerHTML = val.toFixed(3);
				attractor[name] = val;
				updateAttractor();
			});
		}

		function createSliderAlt(container, name, label, defaultValue, min, max) {
			var html = "<div><span id='" + name + "Label'>" + label + "&nbsp;&nbsp;</span>";
			html += "<input id='" + name + "Slider' value='" + 100 * (defaultValue - min) / (max - min) + "' type='range' min='0' max='100' style='width: 300px;'>";
			html += "&nbsp;&nbsp;<span id='" + name + "Value'>" + defaultValue.toFixed(3) + "</span></div>";
			container.insertAdjacentHTML('beforeend', html);

			var slider = document.getElementById(name + "Slider");
			var value = document.getElementById(name + "Value");
			slider.addEventListener('input', function () {
				var val = slider.value * 0.01 * (max - min) + min;
				value.innerHTML = "x" + val.toFixed(2) + " (" + Math.round(window.innerWidth * val) + "x" + Math.round(window.innerHeight * val) + "px)";
				params[name] = val;
			});
		}

		function exportAsObj() {
			var exporter = new THREE.OBJExporter();
			var obj = exporter.parse(mesh);
			var blob = new Blob([obj], { type: 'text/plain' });
			saveAs(blob, 'attractor.obj');
		}

		function exportAsStl() {
			var exporter = new THREE.STLExporter();
			var stl = exporter.parse(mesh);
			var blob = new Blob([stl], { type: 'text/plain' });
			saveAs(blob, 'attractor.stl');
		}

		document.addEventListener("keypress", function (event) {
			if (event.keyCode == 13) {
				saveAsImage();
			}
		});

		

		function saveAsImage() {
			var imgData, imgNode;

			try {
				var scale = params.exportScale;
				showSavingBox();
				renderer.setSize(Math.round(window.innerWidth * scale), Math.round(window.innerHeight * scale));
				
				// We create a new post-processing step here (but couldn't we just rescale the existing?)
				var composer = setupPostProcessing(renderer);
				composer.render(0.01);

				renderer.domElement.toBlob(function (blob) {
					saveAs(blob, "attractor.png");
				});
				renderer.setSize(Math.round(window.innerWidth), Math.round(window.innerHeight));
				composer.setSize(0, 0);
				composer = null;
			} catch (e) {
				console.log(e);
				return;
			}
		}

		var saveFile = function (strData, filename) {
			var link = document.createElement('a');
			if (typeof link.download === 'string') {
				document.body.appendChild(link); //Firefox requires the link to be in the body
				link.download = filename;
				link.href = strData;
				link.click();
				document.body.removeChild(link); //remove the link when done
			} else {
				location.replace(uri);
			}
		}

		ui.insertAdjacentHTML('beforeend', "<div class='dynamicUI'>Attractor: <a class=toggle href='javascript:showFunctionExamples();' >" + attractor.getName() + "</a> </div>");

		if (!Detector.webgl)
			Detector.addGetWebGLMessage();


		var container, stats;
		var params = {
			projection: 'normal',
			background: false,

			rebuildGeometry: function () {
				updateAttractor();
			},

			"showFPS": false,
			"bloomEnabled": true,
			"vignetteEnabled": false,
			"ssaoEnabled": true,
			"fxaoEnabled": true,
			"filmEnabled": true,
			"exposure": 1.23,
			"bloomThreshold": 0.849,
			"bloomStrength": 0.7940718127666893,
			"bloomRadius": 1,
			"metalness": 0.286,
			"clearCoat": 0.33,
			"clearCoatRoughness": 0.363,
			"reflectivity": 0.1,
			"roughness": 0.507,
			"color": 16777215,
			"groundColor": 10988799,
			"wireframe": false,
			"steps": 50,
			"radius": 0.1,
			"stepSize": 0.02,
			"facets": 4,
			"nIntensity": 0.099,
			"sIntensity": 0.154,
			"onlyAO": false,
			"aoRadius": 22.586,
			"aoClamp": 1,
			"lumInfluence": 1,
			"exportScale": 2
		};
		var camera, scene, renderer, controls;
		var bloomPass, renderScene;
		var hdrCubeMap;
		var composer, ssaoPass;
		var standardMaterial;
		var hdrCubeRenderTarget;
		var mesh;
		var effectFilm;

		var globalMax = 0;
		init();

		animate();
		var totalSamples = 0;

		createSliderAlt(document.getElementById('exportSlider'), "exportScale", "Export Scale Factor", params["exportScale"], 1, 10);


		function setupPostProcessing(myRenderer) {
			var copyShader = new THREE.ShaderPass(THREE.CopyShader);
			copyShader.renderToScreen = true;

			var effectVignette = new THREE.ShaderPass(THREE.VignetteShader);
			effectVignette.uniforms["offset"].value = 0.95;
			effectVignette.uniforms["darkness"].value = 2.0;
			effectVignette.enabled = params.vignetteEnabled;

			var effectFilm = new THREE.FilmPass(params.nIntensity, params.sIntensity, myRenderer.getSize().height, false);

			var ssaoPass = new THREE.SSAOPass(scene, camera);
			ssaoPass.radius = params.aoRadius;
			ssaoPass.aoClamp = params.aoClamp;
			ssaoPass.lumInfluence = params.lumInfluence;

			var bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(myRenderer.getSize().width, myRenderer.getSize().height), params.bloomStrength, params.bloomRadius, params.bloomThreshold);//1.0, 9, 0.5, 512);

			var composer = new THREE.EffectComposer(myRenderer);
			composer.setSize(myRenderer.getSize().width, myRenderer.getSize().height);
			composer.addPass(renderScene);
			if (params.bloomEnabled)
				composer.addPass(bloomPass);
			if (params.vignetteEnabled)
				composer.addPass(effectVignette);
			if (params.filmEnabled)
				composer.addPass(effectFilm);
			if (params.ssaoEnabled)
				composer.addPass(ssaoPass);
			composer.addPass(copyShader);
			return composer;
		}

		function init() {
			container = document.createElement('div');
			document.body.appendChild(container);

			camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 2000);
			camera.position.set(0.0, 50 * 0.5, 100 * 0.5);

			scene = new THREE.Scene();

			renderer = new THREE.WebGLRenderer({
				antialias: false,
				preserveDrawingBuffer: true
			});
			renderer.setClearColor(new THREE.Color(0x000000));

			standardMaterial = new THREE.MeshPhysicalMaterial({
				map: null,
				color: params.color,
				clearCoat: params.clearCoat,
				clearCoatRoughness: params.clearCoatRoughness,
				reflectivity: params.reflectivity,
				metalness: params.metalness,
				roughness: params.roughness,
				bumpScale: 0.0,
			});



			var groundMaterial = new THREE.MeshStandardMaterial({
				map: null,
				color: params.groundColor,
				metalness: 0.00,
				roughness: 1.0
			});

			// Create attractor mesh
			setAttractor(0);

			// Create a ground plane.
			var geometry = new THREE.PlaneBufferGeometry(5000, 5000, 2, 2);
			geometry.rotateX(-Math.PI / 2);
			terrainMesh = new THREE.Mesh(geometry, groundMaterial);
			terrainMesh.receiveShadow = true;
			terrainMesh.castShadow = true;
			scene.add(terrainMesh);

			var textureLoader = new THREE.TextureLoader();
			textureLoader.load("./js/roughness_map3.jpg", function (map) {
				map.wrapS = THREE.RepeatWrapping;
				map.wrapT = THREE.RepeatWrapping;
				map.anisotropy = 4;
				map.repeat.set(0.01, 0.01);
				standardMaterial.roughnessMap = map;
				standardMaterial.bumpMap = map;
				standardMaterial.needsUpdate = true;
			});

			var genCubeUrls = function (prefix, postfix) {
				return [prefix + 'px' + postfix, prefix + 'nx' + postfix, prefix + 'py' + postfix, prefix + 'ny' + postfix,
				prefix + 'pz' + postfix, prefix + 'nz' + postfix];
			};

			var hdrUrls = genCubeUrls("./js/cube/pisaHDR/", ".hdr");
			new THREE.HDRCubeTextureLoader().load(THREE.UnsignedByteType, hdrUrls, function (hdrCubeMap) {
				var pmremGenerator = new THREE.PMREMGenerator(hdrCubeMap);
				pmremGenerator.update(renderer);

				var pmremCubeUVPacker = new THREE.PMREMCubeUVPacker(pmremGenerator.cubeLods);
				pmremCubeUVPacker.update(renderer);

				hdrCubeRenderTarget = pmremCubeUVPacker.CubeUVRenderTarget;
			});

			// Lights

			scene.add(new THREE.AmbientLight(0x222222));
			scene.fog = new THREE.FogExp2(0x000000, 0.0025);

			var spotLight = new THREE.SpotLight(0xffffff);
			spotLight.position.set(50, 100, 50);
			spotLight.angle = Math.PI / 7;
			spotLight.penumbra = 0.8
			spotLight.castShadow = true;
			spotLight.shadow.mapSize.width = 1024 * 4;
			spotLight.shadow.mapSize.height = 1024 * 4;

			scene.add(spotLight);

			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.shadowMap.enabled = true;
			renderer.shadowMap.type = THREE.PCFSoftShadowMap; // default THREE.PCFShadowMap
			renderer.toneMapping = THREE.ReinhardToneMapping;
			renderer.gammaInput = true;
			renderer.gammaOutput = true;

			container.appendChild(renderer.domElement);

			renderScene = new THREE.RenderPass(scene, camera);

			var copyShader = new THREE.ShaderPass(THREE.CopyShader);
			copyShader.renderToScreen = true;

			var shaderVignette = THREE.VignetteShader;
			var effectVignette = new THREE.ShaderPass(shaderVignette);
			effectVignette.uniforms["offset"].value = 0.95;
			effectVignette.uniforms["darkness"].value = 2.0;
			effectVignette.enabled = params.vignetteEnabled;
			effectFilm = new THREE.FilmPass(params.nIntensity, params.sIntensity, window.innerHeight, false);

			ssaoPass = new THREE.SSAOPass(scene, camera);
			ssaoPass.radius = params.aoRadius;
			ssaoPass.aoClamp = params.aoClamp;
			ssaoPass.lumInfluence = params.lumInfluence;

			bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), params.bloomStrength, params.bloomRadius, params.bloomThreshold);//1.0, 9, 0.5, 512);
			composer = new THREE.EffectComposer(renderer);
			composer.setSize(window.innerWidth, window.innerHeight);
			composer.addPass(renderScene);
			composer.addPass(bloomPass);
			composer.addPass(effectVignette);
			composer.addPass(effectFilm);
			composer.addPass(ssaoPass);
			composer.addPass(copyShader);


			stats = new Stats();

			controls = new THREE.OrbitControls(camera, renderer.domElement);

			var center = new THREE.Box3().setFromObject(mesh).getCenter();
			controls.target.set(center.x, center.y, center.z);

			controls.rotateSpeed = 0.3;
			controls.autoRotate = false;
			controls.enableDamping = true;
			controls.update();

			window.addEventListener('resize', onWindowResize, false);

			var gui = new dat.GUI();

			var effectFolder = gui.addFolder('Effects');
			effectFolder.add(params, 'bloomEnabled').name("Bloom").onChange(function (value) {
				bloomPass.enabled = value;
			});
			effectFolder.add(params, 'vignetteEnabled').name("Vignette").onChange(function (value) {
				effectVignette.enabled = value;
			});
			effectFolder.add(params, 'ssaoEnabled').name("SSAO").onChange(function (value) {
				ssaoPass.enabled = value;
			});
			effectFolder.add(params, 'filmEnabled').name("Film").onChange(function (value) {
				effectFilm.enabled = value;
			});

			var bloomFolder = gui.addFolder('Bloom and Exposure');
			bloomFolder.add(params, 'exposure', 0.1, 2).name("Exposure");
			bloomFolder.add(params, 'bloomThreshold', 0.0, 1.0).name("Bloom threshold").onChange(function (value) {
				bloomPass.threshold = Number(value);
			});
			bloomFolder.add(params, 'bloomStrength', 0.0, 3.0).name("Bloom strength").onChange(function (value) {
				bloomPass.strength = Number(value);
			});
			bloomFolder.add(params, 'bloomRadius', 0.0, 1.0).name("Bloom radius").onChange(function (value) {
				bloomPass.radius = Number(value);
			});


			var materialFolder = gui.addFolder('Material');
			materialFolder.add(params, 'metalness', 0.0, 1.0).name("Metalness").onChange(function (value) {
				if (mesh.material !== undefined)
					mesh.material.metalness = Number(value);
			});
			materialFolder.add(params, 'clearCoat', 0.0, 1.0).name("Clear Coat").onChange(function (value) {
				if (mesh.material !== undefined)
					mesh.material.clearCoat = Number(value);
			});
			materialFolder.add(params, 'clearCoatRoughness', 0.0, 1.0).name("CC Roughness").onChange(function (value) {
				if (mesh.material !== undefined)
					mesh.material.clearCoatRoughness = Number(value);
			});
			materialFolder.add(params, 'reflectivity', 0.0, 1.0).name("Reflectivity").onChange(function (value) {
				if (mesh.material !== undefined)
					mesh.material.reflectivity = Number(value);
			});
			materialFolder.add(params, 'roughness', 0.0, 1.0).name("Roughness").onChange(function (value) {
				if (mesh.material !== undefined)
					mesh.material.roughness = Number(value);
			});

			materialFolder.addColor(params, 'color').name("Color").onChange(function (value) {
				if (mesh.material !== undefined)
					mesh.material.color = new THREE.Color(value);
			});

			materialFolder.addColor(params, 'groundColor').name("Ground color").onChange(function (value) {
				if (terrainMesh.material !== undefined)
					terrainMesh.material.color = new THREE.Color(value);
			});

			materialFolder.add(params, 'wireframe').name("Wireframe").onChange(function (value) {
				updateAttractor();
			});
			var geometryFolder = gui.addFolder('Geometry');
			geometryFolder.add(params, 'steps', 1, 500, 1).name("Steps (thousands)");
			geometryFolder.add(params, 'radius', 0.01, 1.0).name("Radius");
			geometryFolder.add(params, 'stepSize', 0.001, 0.1).name("Step size");
			geometryFolder.add(params, 'facets', 3, 8, 1).name("Tube facets");
			geometryFolder.add(params, 'rebuildGeometry').name("Rebuild geometry");

			var scanLinesFolder = gui.addFolder('Scan Lines');
			scanLinesFolder.add(params, 'nIntensity', 0, 1.0).name("Noise level").onChange(function (value) {
				effectFilm.uniforms.nIntensity.value = Number(value);
			});
			scanLinesFolder.add(params, 'sIntensity', 0, 1.0).name("Scan lines").onChange(function (value) {
				effectFilm.uniforms.sIntensity.value = Number(value);
			});

			var ssaoFolder = gui.addFolder('SSAO');
			ssaoFolder.add(params, 'onlyAO', false).name("Only AO").onChange(function (value) { ssaoPass.onlyAO = value; });
			ssaoFolder.add(params, 'aoRadius').name("AO radius").min(0).max(64).name("AO radius").onChange(function (value) { ssaoPass.radius = value; });
			ssaoFolder.add(params, 'aoClamp').min(0).max(1).name("AO clamp").onChange(function (value) { ssaoPass.aoClamp = value; });
			ssaoFolder.add(params, 'lumInfluence').min(0).max(1).name("Lum influence").onChange(function (value) { ssaoPass.lumInfluence = value; });

			gui.add(params, 'showFPS', 0.0, 1.0).name("Show FPS").onChange(function (value) {
				if (!value) {
					container.removeChild(stats.dom);
				} else {
					container.appendChild(stats.dom);
				};
			});

			//gui.remember(params);
			gui.open();
		}

		function onWindowResize() {
			var width = window.innerWidth;
			var height = window.innerHeight;

			camera.aspect = width / height;
			camera.updateProjectionMatrix();
			ssaoPass.setSize(width, height);
			renderer.setSize(width, height);
			composer.setSize(width, height);
			effectFilm.uniforms.sCount.value = height;
		}

		function animate() {
			requestAnimationFrame(animate);
			stats.begin();
			render();
			stats.end();
		}

		function render() {
			controls.update();
			if (standardMaterial !== undefined) {
				var newEnvMap = standardMaterial.envMap;
				newEnvMap = hdrCubeRenderTarget ? hdrCubeRenderTarget.texture : null;
				if (newEnvMap !== standardMaterial.envMap) {
					standardMaterial.envMap = newEnvMap;
					standardMaterial.needsUpdate = true;
				}
			}
			renderer.toneMappingExposure = Math.pow(params.exposure, 4.0);
			//renderer.render(scene,camera);
			composer.render(0.01);
		}


	</script>

</body>

</html>